@model IEnumerable<DoAnTotNghiep_WebMinhChau.Models.HoaDon>

@{
    ViewBag.Title = "TheoDoiDonHang";
    Layout = "~/Views/Shared/_LayoutGeneral.cshtml";
    var isLoggedIn = Session["SDT"] != null;
}

<style>
    .rating {
        direction: rtl;
        display: inline-block;
    }

    .star {
        font-size: 2em;
        color: gray;
        cursor: pointer;
    }

        .star:hover,
        .star:hover ~ .star {
            color: gold;
        }

        .star.selected {
            color: gold;
        }

    .btn-custom {
        width: 100%;
        height: 50px;
    }

    .container {
        max-width: 1500px;
    }
</style>

@if (Session["Email"] != null || Session["SDT"] != null)
{
    if (Model != null && Model.Any())
    {
        <table class="table">
            <tr>
                <th>Họ Tên</th>
                <th>Thời gian đặt hàng</th>
                <th>SDT</th>
                <th>Hình thức nhận hàng</th>
                <th>Địa Chỉ</th>
                <th>Phương thức thanh toán</th>
                <th>Tổng tiền</th>
                <th>Trạng thái</th>
                <th></th>
            </tr>

            @foreach (var item in Model)
            {
                <tr>
                    <td>@Html.DisplayFor(modelItem => item.HoTen)</td>
                    <td>@Html.DisplayFor(modelItem => item.ThoiGian)</td>
                    <td>@Html.DisplayFor(modelItem => item.SDT)</td>
                    <td>@Html.DisplayFor(modelItem => item.HinhThucNhanHanh)</td>
                    @if (item.HinhThucNhanHanh == "Nhận Hàng Tại Quầy Thuốc")
                    {
                        <td>@Html.DisplayFor(modelItem => item.DiaChiNhanHang)</td>
                    }
                    else
                    {
                        <td>
                            @Html.DisplayFor(modelItem => item.DiaChiNhanHang) -
                            @Html.DisplayFor(modelItem => item.PhuongXa) -
                            @Html.DisplayFor(modelItem => item.QuanHuyen) -
                            @Html.DisplayFor(modelItem => item.TinhThanh)
                        </td>
                    }
                    <td>@Html.DisplayFor(modelItem => item.PTTT)</td>
                    <td>@String.Format("{0:N0} VNĐ", item.TongTien)</td>
                    <td>@Html.DisplayFor(modelItem => item.TrangThai)</td>
                    <td style="width:200px">
                        <button type="button"
                                onclick="loadChiTietHoaDon('@item.MaHD')"
                                class="btn btn-danger"
                                style="width: 89px; padding: 2px; background-color: transparent; border: 1px solid #f8d7da; color: #dc3545; transition: all 0.3s ease;">
                            Chi tiết hóa đơn
                        </button>
                        @if (item.TrangThai == "Chờ nhận hàng")
                        {
                            <!-- Button hiển thị khi trạng thái là "Chờ nhận hàng" -->
                            <button type="button" onclick="window.location.href='@Url.Action("Edit", "HoaDon", new { MaHD = item.MaHD, actionType = "NhanHang" })'"
                                    class="btn btn-success"
                                    style="width: 89px; padding: 2px; background-color: transparent; border: 1px solid #ffecb3; color: #fd7e14; transition: all 0.3s ease;">
                                Đã nhận được hàng
                            </button>

                        }
                        else if (item.TrangThai == "Chờ xác nhận" && item.PTTT == "Thanh toán khi nhận hàng")
                        {
                            <!-- Button hiển thị khi trạng thái là "Chờ xác nhận" -->
                            <button type="button" onclick="window.location.href='@Url.Action("Edit", "HoaDon", new { MaHD = item.MaHD, actionType = "HuyDon" })'"
                                    class="btn btn-danger"
                                    style="width: 89px; padding: 2px; background-color: transparent; border: 1px solid #f8d7da; color: #dc3545; transition: all 0.3s ease;">
                                Huỷ Đơn Hàng
                            </button>
                        }

                    </td>

                </tr>
            }
        </table>
    }
    else
    {
        <div class="container mt-5">
            <h4 class="text-center text-danger">Không có đơn hàng nào được tìm thấy!!!</h4>
        </div>
    }
}

else if (!isLoggedIn)
{
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white text-center">
                        <h4 class="mb-0">Kiểm tra đơn hàng</h4>
                    </div>
                    <div class="card-body">
                        <h4 class="text-center text-primary font-weight-bold" style="font-size: 1.5rem; letter-spacing: 1px; text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.1);">
                            Vui lòng nhập số điện thoại để kiểm tra đơn hàng của bạn.
                        </h4>
                        <form method="post" action="@Url.Action("SearchByPhone", "HoaDon")">
                            <div class="form-group">
                                <label for="phoneNumber">Số điện thoại:</label>
                                <input type="text" id="phoneNumber" name="phoneNumber" class="form-control" required placeholder="Nhập số điện thoại của bạn" />
                            </div>
                            <div class="text-center mt-4">
                                <button type="submit" class="btn btn-primary btn-lg">Tìm kiếm</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
<!-- Modal chi tiết hóa đơn -->
<div id="chiTietHoaDonModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết hóa đơn</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table id="chiTietHoaDonTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Tên sản phẩm</th>
                            <th>Số lượng</th>
                            <th>Đơn giá</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
    function loadChiTietHoaDon(maHD) {
        $.ajax({
            url: '@Url.Action("GetChiTietHoaDon", "HoaDon")',
            type: 'GET',
            data: { MaHD: maHD },
            success: function (data) {
                let tableBody = $('#chiTietHoaDonTable tbody');
                tableBody.empty(); // Xóa dữ liệu cũ

                // Duyệt qua danh sách chi tiết hóa đơn và thêm vào bảng
                data.forEach(function (item) {
                    tableBody.append(`
                        <tr>
                            <td>${item.SanPham.TenSP}</td>
                            <td>${item.SoLuong}</td>
                            <td>${item.DonGia}</td>
                        </tr>
                    `);
                });

                // Hiển thị bảng
                $('#chiTietHoaDonModal').modal('show');
            },
            error: function () {
                alert("Không thể tải dữ liệu. Vui lòng thử lại.");
            }
        });
    }
</script>

